services:
  backend:
    build:
      context: ./backend
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: "sqlite:////app/data/antique_catalogue.db"
      UPLOADS_PATH: "/app/uploads"
      JWT_SECRET: "${JWT_SECRET:-change-me}"
      JWT_ALGORITHM: "${JWT_ALGORITHM:-HS256}"
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-30}"
      AUTO_VERIFY_EMAIL: "${AUTO_VERIFY_EMAIL:-false}"
      REFRESH_TOKEN_COOKIE_PATH: "${REFRESH_TOKEN_COOKIE_PATH:-/}"
      ADMIN_EMAIL: "${ADMIN_EMAIL:-}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-}"
      ADMIN_TOKEN_EXPIRE_MINUTES: "${ADMIN_TOKEN_EXPIRE_MINUTES:-60}"
      SMTP_HOST: "${SMTP_HOST:-}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER:-}"
      SMTP_PASSWORD: "${SMTP_PASSWORD:-}"
      SMTP_FROM: "${SMTP_FROM:-}"
      SMTP_USE_TLS: "${SMTP_USE_TLS:-true}"
    volumes:
      - backend-data:/app/data
      - backend-uploads:/app/uploads
    command: >
      sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"

  frontend:
    build:
      context: ./frontend
    ports:
      - "3010:3000"
    environment:
      # Uses /api by default (relative URL, works on any domain)
      # Set NEXT_PUBLIC_API_URL for local dev: http://localhost:8000
      NEXT_PUBLIC_API_URL: "/api"
    depends_on:
      - backend

volumes:
  backend-data:
  backend-uploads:
